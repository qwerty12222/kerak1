const axios = require('axios');

export default async function handler(req, res) {
    if (req.method !== 'GET') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    const BOT_TOKEN = process.env.BOT_TOKEN;
    const webhookUrl = req.query.url || `https://${req.headers.host}`;
    
    if (!BOT_TOKEN) {
        return res.status(400).json({ error: "BOT_TOKEN not configured" });
    }
    
    if (!webhookUrl) {
        return res.status(400).json({ error: "Webhook URL required" });
    }
    
    try {
        const response = await axios.post(`https://api.telegram.org/bot${BOT_TOKEN}/setWebhook`, {
            url: `${webhookUrl}/api/webhook`,
            allowed_updates: ["message", "callback_query", "inline_query"],
            drop_pending_updates: true,
            max_connections: 40,
            secret_token: process.env.WEBHOOK_SECRET || undefined
        });
        
        res.status(200).json({
            success: true,
            webhook_url: `${webhookUrl}/api/webhook`,
            telegram_response: response.data,
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        console.error('Set webhook error:', error);
        res.status(500).json({ 
            error: error.message,
            success: false,
            timestamp: new Date().toISOString()
        });
    }
}
